version: '3.8'

services:
  server1:
    build: ./server1-nestjs
    ports:
      - "3000:3000" # container 内の 3000 番ポートをホストの 3000 番ポートにマッピング
    volumes:
      - ./server1-nestjs:/usr/src/app
    environment:
      DATABASE_HOST: mysql
      DATABASE_USER: user
      DATABASE_PASSWORD: password
      DATABASE_NAME: server1_db
    command: npm run start:dev
    depends_on:
      - server1-mysql
  
  server1-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: server1_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    ports:
      - "3306:3306" # server1 の MySQL はホストの 3306 番ポートにマッピング

  server2:
    build: ./server3-nestjs
    ports:
      - "3001:3000" # container 内の 3000 番ポートをホストの 3001 番ポートにマッピング
    volumes:
      - ./server3-nestjs:/usr/src/app
    environment:
      DATABASE_HOST: mysql
      DATABASE_USER: user
      DATABASE_PASSWORD: password
      DATABASE_NAME: server2_db
    command: npm run start:dev
    depends_on:
      - server2-mysql

  server2-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: server2_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    ports:
      - "3307:3306" # server2 の MySQL はホストの 3307 番ポートにマッピング

  # kafka1:
  #   image: confluentinc/cp-kafka:latest
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     KAFKA_BROKER_ID: 1
  #     KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:9092
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #   depends_on:
  #     - zookeeper

  # kafka2:
  #   image: confluentinc/cp-kafka:latest
  #   ports:
  #     - "9093:9092"
  #   environment:
  #     KAFKA_BROKER_ID: 2
  #     KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:9092
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #   depends_on:
  #     - zookeeper

  # zookeeper:
  #   image: confluentinc/cp-zookeeper:latest
  #   ports:
  #     - "2181:2181"
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #     ZOOKEEPER_TICK_TIME: 2000